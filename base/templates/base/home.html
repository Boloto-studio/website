{% extends "base/layout.html" %}
{% load i18n %}

{% block body %}
<main id="home">
    <section id="hero" class="hero-carousel">
        {% for slide in hero_slides %}
        <article class="hero-slide vertical-{{ slide.vertical_align }} horizontal-{{ slide.horizontal_align }}"
            data-bg-image="{{ slide.image|escape }}">
            <div class="hero-slide-content">
                <h1>{{ slide.title }}</h1>
                {% if slide.subtitle %}<p>{{ slide.subtitle }}</p>{% endif %}
                {% if slide.link %}<a href="{{ slide.link|escape }}" class="button hero-cta">{{ slide.link_text}}</a>{%endif %}
            </div>
        </article>
        {% empty %}
        <article class="hero-slide hero-slide-placeholder">
            <div class="hero-slide-content">
                <h1>{% trans "Welcome to Boloto Studio" %}</h1>
                <p>{% trans "Creating immersive gaming experiences" %}</p>
            </div>
        </article>
        {% endfor %}
    </section>
    <script>
        document.querySelectorAll('.hero-slide[data-bg-image]').forEach(function (slide) {
            var url = slide.dataset.bgImage;
            // Validate URL starts with https:// or http:// to prevent javascript: or data: URLs
            // Additional validation: ensure no embedded javascript
            if (url && (url.startsWith('https://') || url.startsWith('http://')) && !url.includes('javascript:')) {
                slide.style.backgroundImage = 'url("' + url.replace(/["\\]/g, '') + '")';
            }
        });

        // Auto-scroll carousel with looping
        (function() {
            var carousel = document.getElementById('hero');
            var slides = carousel.querySelectorAll('.hero-slide');
            if (slides.length <= 1) return;

            var currentIndex = 0;
            var autoScrollInterval = 5000; // 5 seconds between slides
            var intervalId;
            var scrollTimeout;

            function scrollToSlide(index) {
                if (index >= slides.length) {
                    index = 0;
                } else if (index < 0) {
                    index = slides.length - 1;
                }
                currentIndex = index;
                slides[index].scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
            }

            function nextSlide() {
                scrollToSlide(currentIndex + 1);
            }

            function startAutoScroll() {
                intervalId = setInterval(nextSlide, autoScrollInterval);
            }

            function resetAutoScroll() {
                clearInterval(intervalId);
                startAutoScroll();
            }

            // Debounced scroll handler to update current index when user manually scrolls
            carousel.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    var slideWidth = slides[0] ? slides[0].offsetWidth : 0;
                    if (slideWidth === 0) return;
                    var scrollLeft = carousel.scrollLeft;
                    var newIndex = Math.round(scrollLeft / slideWidth);
                    if (newIndex !== currentIndex && newIndex >= 0 && newIndex < slides.length) {
                        currentIndex = newIndex;
                        resetAutoScroll();
                    }
                }, 100);
            });

            // Pause auto-scroll on hover
            carousel.addEventListener('mouseenter', function() {
                clearInterval(intervalId);
            });

            carousel.addEventListener('mouseleave', function() {
                startAutoScroll();
            });

            // Start auto-scrolling
            startAutoScroll();
        })();
    </script>
    <!-- <div id="hero-divider"></div> -->
    <div id="under-hero">
        <div id="under-hero-left">
            <section id="short-about">
                <div class="fancy-title">
                    <div class="fancy-title-line">
                        <span></span>
                    </div>
                    <h2>{% trans "Us" %}</h2>
                    <div class="fancy-title-line">
                        <span></span>
                    </div>
                </div>
                <p>Holy moly</p>
            </section>
            <section id="events">
                <div class="fancy-title">
                    <div class="fancy-title-line">
                        <span></span>
                    </div>
                    <h2>{% trans "Upcoming events" %}</h2>
                    <div class="fancy-title-line">
                        <span></span>
                    </div>
                </div>
                {% for event in events %}
                <a href="{{event.link}}" class="event no-style">
                    <div class="left">
                        <h2>{{event.title|truncatechars:35}}</h2>
                        <span>{{event.date}}</span>
                    </div>
                    <div class="right"><span class="material-symbols-outlined">videocam</span></div>
                </a>
                {% empty %}
                <h2 style="text-align: center;">{% trans "Something is coming. Soon..." %}</h2>
                {% endfor %}
            </section>
        </div>
        <section id="blog">
            <div class="fancy-title">
                <div class="fancy-title-line">
                    <span></span>
                </div>
                <h2>{% trans "What's going on" %}</h2>
                <div class="fancy-title-line">
                    <span></span>
                </div>
            </div>
            <div id="posts-container">
                {% for post in posts %}
                <div class="blogpost">
                    <div class="blog-bottom">
                        <h1>{{ post.title }}</h1>
                        <span>{{ post.published_date }}</span>
                        <p>{{ post.content|truncatechars:650 }}</p>
                    </div>
                </div>
                {% empty %}
                <h2 style="text-align: center;">{% trans "Keep an eye on updates!" %}</h2>
                {% endfor %}
            </div>
        </section>
    </div>
</main>
{% endblock %}